---
title: "Quick Start"
author: "Shu Fai Cheung"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quick Start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(semlbci)
```

# Introduction

This package includes functions for finding the likelihood based confidence intervals (LBCIs) of parameters in the fitted object of a structural equation modeling (SEM) function. Currently, it only supports the output from `lavaan::lavaan()`.

# Fit a model to a dataset

The package has a dataset, `simple_med`, with three variables, `x`, `m`, and `y`. Let us fit a simple complete mediation model to this datast.

```{r}
data(simple_med)
dat <- simple_med
head(dat)
library(lavaan)
mod <- 
"
m ~ a*x
y ~ b*m
ab := a * b
"
# We set fixed.x = FALSE because we will also find the LBCIs for standardized solution
fit <- sem(mod, simple_med, fixed.x = FALSE)
```

If we want to find the LBCIs for standardized solution, we usually should also treat exogenous variables as random variables, and take into account the sampling error in estimating their variances and covariances.

To illustrate how to find the LBCIs for user defined parameters, we labelled the `m ~ x` path by `a`, the `y ~ m` path by `b`, and defined the indirect effect, `ab`, by `a * b`.

This is the summary:

```{r}
summary(fit, standardized = TRUE)
```

# Exmaples

The main function to find the LBCIs for free parameters is `semlbci::semlbci()`. This should be the only function used by normal users. We will first illustrate its usage by some examples, and then present other technical details in the following section.

## Find the LBCI for a free parameter

All free parameters can be specified in `lavaan` style. For example, the path from `m` to `y` is denoted by "y ~ m", and the covariance or correlation between `x` and `m` (not in the example) is denoted by "x ~~ m" (order does not matter).

```{r}
out <- semlbci(sem_out = fit,
               pars = c("y ~ m",
                        "m ~ x"))
```

The output is the parameter table of the fitted `lavaan` object, with two columns added, `lbci_lb` and `lbci_ub`, the likelihood-based lower bounds and upper bounds, respectively. The column of point estimates in the fit object is positioned between these two columns of bounds. Diagnostic information will be appended to the output (described in details below).

```{r}
out
```

## Find the LBCI for a user defined parameter

To find the LBCI for a user defined parameter, use `label :=`, where `label` is the label used in the model. The definition of this parameter can be omitted. Content after `:=` will be ignored.

```{r}
out <- semlbci(sem_out = fit,
               pars = c("ab := "))
out
```

## Find the LBCI for the parameters in the standardized metric

By the default, the unstandardized solution is used. If the LBCIs for the standardized solution solution are desired, set `standardized = TRUE`.

```{r}
out <- semlbci(sem_out = fit,
               pars = c("y ~ m",
                        "m ~ x"),
               standardized = TRUE)
out
```

The LBCIs for user defined parameters can be requested similarly.

```{r}
out <- semlbci(sem_out = fit,
               pars = c("ab :="),
               standardized = TRUE)
out
```

Note that it can be very slow when finding the LBCIs for standardized solution. In the above example, the time used to find the lower bound of the standardized indirect effect is `r out[out$op == ":=", "time_lb"]` second(s), and that for the upper bound is `r out[out$op == ":=", "time_ub"]` second(s). This is because a large number of variables are involved even for the standardized indirect effect with one mediator (the variances of `x` and `m`, the error variance of `y`, and the two unstandardized path coefficients `m ~ x` and `y ~ m`).

## Specify the coverage probability of the LBCI

This can be done by setting `ciperc`. The default is .95.

```{r}
out <- semlbci(sem_out = fit,
               pars = c("y ~ m",
                        "m ~ x"),
               ciperc = .99)
out
```

# Basic arguments in `semlbci::semlbci()`

## `sem_out` and `pars`: The fit object from `lavaan::lavaan()` and the parameters for which LBCIs will be computed

The only required argument for `semlbci::semlbci()` is `sem_out`, the fit object from `lavaan::lavaan()` or its variants (e.g., `lavann::cfa()` and `lavaan::sem()`). By default, `semlbci::semlbci()` will find the LBCIs for all free parameters and user defined parameters, which can take a long time for a model with many parameters. Moreover, LBCI is usually used for parameters which may not be suitable for Wald-type confidence interval, such as the indirect effect or a parameter in the standardized solution. These parameters may have sampling distributions that are substantially nonnormal or  asymmetric.

Therefore, it is recommended to use `semlbci::semlbci()` only for selected parameters. The argument `pars` should be a list of strings which specifies the parameters for which LBCIs will be computed (detailed below).

If time is not a concern, for example, when users want to explore the LBCIs for all free and user defined parameters in a final model, then `pars` can be omitted.

## `ciperc`: Level of confidence

By default, the 95% LBCIs for the unstandardized solution will be computed. To change the level of confidence, set the argument `ciperc` to the desired coverage probability, e.g., .95 for 95%, .90 for 90%. 

## `standardized`: Whether standardized solution is used

By default, the LBCIs for the unstandardized solution will be computed. If the LBCIs for the standardized solution are desired, set `standardized = TRUE`. Note that it is much slower to find the LBCIs for the standardized solution than for the unstandardized solution.

## `method`: Method to be used for computing the LBCIs

The method by Neale and Miller (1997) is used to search for the bounds. The method proposed by Wu and Neale (2012), though available if `method` is set to "wn", should not be used because it is not fully tested. It was kept in the function only as an experimental method.

## Other arguments

For detailed documentation, please refer to help page of `semlbci::semlbci()`.

# Diagnostic information

Columns with diagnostic information will always be appended to the output. This feature cannot be turned off because we believe that it is important to check the diagnostic information to see if there are any anomalies in the search. Unlike Wald-type CIs, LBCIs are found by optimization rather than by closed-form equations. It is possible that the bounds are difficult to found for some situations. 

## `status_lb` and `status_ub`

If equal to 0, then the optimization should fine. Any value other than 0 indicates one or more issues in the optimization. Users are recommended to `verbose = TRUE` and inspect the attributes `lb_diag` or `ub_diag` (e.g., `attr(out, "lb_diag")` in the example above) for the source of the issue.

## `ci_org_lb` and `ci_org_ub`

The confidence intervals computed by `lavaan`. Included in the output for comparison.

## `ratio_lb` and `ratio_ub`

The ratio of a LBCI bound to its corresponding `lavaan` confidence bound. This ratio is not expected to be zero. However, if the ratio is too large or too small, users should decide whether it is usual.


## `post_check_lb` and `post_check_ub`

## `time_lb` and `time_ub`

## `method`

# Limitations

This package is still in its (very) early development (pre-alpha). These are the limitations:

- IMPORTANT: It uses only the method by Neale and Miller (1997), as demonstrated by Pek and Wu (2015), and does not check whether a parameter is near its boundary. The more advanced methods by Pritikin, Rappaport, and Neale (2017) should be considered.

- It only supports single-sample SEM. It *may* work for multiple-sample SEM but this has not been tested.

- It only supports models fitted by maximum likelihood (ML) estimation, including full information maximum likelihood (FIML).

- It only supports models with continuous variables.

# References

Neale, M. C., & Miller, M. B. (1997). The use of likelihood-based confidence intervals in genetic models. *Behavior Genetics, 27*(2), 113–120.

Pek, J., & Wu, H. (2015). Profile likelihood-based confidence intervals and regions for structural equation models. *Psychometrika, 80*(4), 1123–1145. https://doi.org/10.1007/s11336-015-9461-1

Pritikin, J. N., Rappaport, L. M., & Neale, M. C. (2017). Likelihood-based confidence intervals for a parameter with an upper or lower bound. *Structural Equation Modeling: A Multidisciplinary Journal, 24*(3), 395-401. https://doi.org/10.1080/10705511.2016.1275969

Wu, H., & Neale, M. C. (2012). Adjusted confidence intervals for a bounded parameter. *Behavior Genetics, 42*(6), 886–898. https://doi.org/10.1007/s10519-012-9560-z

